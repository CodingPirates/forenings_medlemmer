{% extends 'members/base.html' %}
{% block content %}
  <h2>Aktiviteter i Coding Pirates</h2>
  <p>
    Her kan du tilmelde dit barn en aktivitet i en Coding Pirates afdeling.<br>
    Det kan enten være en åben aktivitet der ikke kræver invitation, eller
    hvis I har modtaget en invitation vil den kunne ses her.<br>
    De aktiviteter som I allerede er tilmeldt vil også fremgå på denne side.
  </p>
  <p>
    Hvis du vil skrive dig op til en afdeling og få sendt invitationer ved nye
    events kan du gøre det på afdelingssiden.<br>
    <a class="button" href="{% url "department_signup" %}">
      Gå til Afdelings opskrivninger
    </a>
  </p>

  <div class="tabs">
    <ul>
      <li>Invitationer</li>
      <li>Nuværende og kommende aktiviteter</li>
      <li>Tilmeldte aktiviteter</li>
    </ul>
    
    {% if family %}
    <section>
        <h2>Invitationer</h2>
        <p>
          Denne liste indeholder invitationer til aktiviteter, hvor der 
          enten er fri tilmelding (først til mølle) eller invitationer til
          aktiviteter I har stået på venteliste til.<br>
          I vil modtage en e-mail på <em>{{ family.email }}</em> 
          når der er aktiviteter, som I kan tilmelde jer.
        </p>
        {% if invites %}
          <p><i>Vær opmærksom på, at du tilmelder dig den rigtige afdeling!</i></p>
          <table>
            <thead>
              <tr>
                <!-- <th>Navn</th> -->
                <th>Afdeling</th>
                <th>Aktivitet</th>
                <th>Adresse</th>
                <th>Alder</th>
                <th>Info</th>
                <th>Handling</th>
              </tr>
            </thead>
            <tbody>
              {% for invite in invites %}
                <tr>
                  <!-- <td>{{ invite.person.name }}</td> -->
                  <td>
                    Coding Pirates<br>
                    {{ invite.activity.department.name }}
                  </td>
                  <td>
                    <a href="{% url 'activity_signup' invite.activity.id invite.person.id %}">
                      {{ invite.activity.name }}
                    </a>
                  </td>
                  <td>
                    {% if invite.activity.placename %}
                      {{ invite.activity.placename }}<br>
                    {% endif %}
                    {{ invite.activity.streetname }}
                    {{ invite.activity.housenumber }}
                    {% if invite.activity.floor %}
                      {{ invite.activity.floor }}
                    {% endif %}
                    {% if invite.activity.door %}
                      {{ invite.activity.door }}
                    {% endif %}
                    <br>
                    {{ invite.activity.zipcode }}
                    {{ invite.activity.city }}
                  </td>
                  <td>
                    {{ invite.activity.min_age }} - {{ invite.activity.max_age }}
                  </td>
                  <td>
                    <a
                      class="button"
                      href="{% url 'activity_view_family' invite.activity.id %}"
                    >
                      Læs mere
                    </a>
                  </td>
                  <td>
                    
                    <a class="button-success"
                      href="{% url 'activity_signup' invite.activity.id invite.person.id %}">
                      Tilmeld {{ invite.person.name }}
                    </a>
                    <a class="button-danger"
                      href="{% url 'invitation_decline' family.unique invite.id %}">
                      Afslå invitation
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="info-box">
            Der er endnu ikke åbnet for tilmelding til aktiviteter.<br>
            Vi sender en e-mail til <em>{{ family.email }}</em> når vi er klar til at 
            modtage tilmeldinger.
          </div>
        {% endif %}
      {% endif %}
    </section>

    <section id="current_activities">
      {% if current_activities %}
        <h2>Nuværende og kommende aktiviteter</h2>
        {% regroup current_activities by department.address.region as departments_region %}
        <p>Denne liste indeholder igangværende og kommende aktiviteter.<br>
          For aktiviteter med fri tilmelding, kan I tilmelde Jer direkte, og ellers
          kan I opskrive Jer på venteliste til afdelingen.
        </p>
        <input 
          type="text" 
          id="input-search-text"
          onkeyup="filter_rows_in_table(
            'input-search-text', 
            'activity-per-region',
            'activity-data'
            )" 
          placeholder="Søg efter..."
        >
        <div class="tabs">
          <ul>
            {% for region in departments_region %}
              <li>{{ region.grouper }}</li>
            {% endfor %}
          </ul>

          {% for region in departments_region %}
            <section class="activity-per-region">
              <table>
                <thead>
                  <tr>
                    <th>Afdeling</th>
                    <th>Aktivitet</th>
                    <th>Adresse</th>
                    <th>Alder</th>
                    <th>Info</th>
                    <th>Dato</th>
                    <th>Handling</th>
                  </tr>
                </thead>
                <tbody class="activity-data">
                  {% for activity in region.list %}
                    <tr>
                      <td>Coding Pirates<br>
                        {{ activity.department.name }}
                      </td>
                      <td>{{ activity.name }}</td>
                      <td>
                        {% if activity.placename %}
                          {{ activity.placename }}<br>
                        {% endif %}
                        {{ activity.streetname }}
                        {{ activity.housenumber }}
                        {% if activity.floor %}
                          {{ activity.floor }}
                        {% endif %}
                        {% if activity.door %}
                          {{ activity.door }}
                        {% endif %}
                        <br>
                        {{ activity.zipcode }}
                        {{ activity.city }}
                      </td>
                      <td>{{ activity.min_age }} - {{ activity.max_age }}</td>
                      <td>
                        <a
                          class="button"
                          href="{% url 'activity_view_family' activity.id %}"
                        >
                          Læs mere
                        </a>
                      </td>
                      <td>
                        {% if activity.start_date == activity.end_date %}
                          {{ activity.start_date }}
                        {% else %}
                          {{ activity.start_date }} <br> - {{ activity.end_date }}
                        {% endif %}
                      </td>
                      <td>
                        {% if family %}
                          {% if activity.persons|length == 0 %}
                            <p>Denne aktivitet kræver invitation eller er kun
                              åben for bestemte aldersgrupper. Tryk
                                <a href="{% url 'department_signup' activity.id person.id %}">
                                  her
                                </a>
                              for at opskrive på venteliste til næste gang 
                              {{ activity.department.name }} opretter en ny aktivitet.
                            </p>
                          {% endif %}
                          {% for child in children %}
                            {% if activity.open_invite %}
                              {% if activity.id in child.participating_activities %}
                                <div class="center">
                                  {{ child.person.firstname }} er tilmeldt
                                </div>
                              {% else %}
                                  {% if child.person in activity.persons %}
                                    <a 
                                      class="button-success" 
                                      href="{% url 'activity_signup' activity.id child.person.id %}"
                                    >
                                      Tilmeld {{ child.person.firstname }}
                                    </a>
                                  {% endif %}
                              {% endif %}
                            {% else %}
                              {% if activity.department in child.departments_is_waiting %}
                                <div class="center">
                                  {{ child.person.firstname }} er opskrevet
                                </div>
                              {% else %}
                                <a 
                                  class="button-success" 
                                  href="{% url 'waiting_list_subscription' child.person.id activity.department.id 'subscribe' %}"
                                >
                                  Opskriv {{ child.person.firstname }} på venteliste
                                </a>
                              {% endif %}
                            {% endif %}
                          {% endfor %}
                        {% else %}
                          {% if activity.open_invite %}
                            <a 
                              class="button-success" 
                              href="{% url 'person_login' %}"
                            >
                              Tilmeld
                            </a>
                          {% else %}
                            <a 
                              class="button-success" 
                              href="{% url 'person_login' %}"
                            >
                              Opskriv på venteliste
                            </a>
                          {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </section>
          {% endfor %}
        </div>
      {% else %}
        <div class="info-box">
          Der er ikke nogen aktiviteter.
        </div>
      {% endif %}
    </section>

    <section id="participation">
      {% if family %}
        <h2>Tilmeldte aktiviteter</h2>
        <p>
          Dette er de aktiviteter jeres børn er tilmeldt. 
          I kan klikke på navnet for hver aktivitet, for at se flere 
          detaljer om hvor og hvornår det foregår.<b
        </p>
        {% if participating %}
          <p>
            Hvis en aktivitet har en rød <kbd>betal</kbd>-knap, er 
            betalingen ikke registreret. 
            Tryk på knappen for at betale.
          </p>
          <table>
            <thead>
              <tr>
                <th>Navn</th>
                <th>Aktivitet</th>
                <th>Afdeling</th>
                <th>Dato</th>
              </tr>
            </thead>
            <tbody>
              
                {% for participation in participating %}
                  <tr>
                    <td>{{ participation.member.person.name }}</td>
                    <td>
                      <a 
                        href="{% url 'activity_view_person' participation.activity.id participation.member.person.id %}"
                      >
                        {{ participation.activity.name }}
                      </a>
                      {% if not participation.paid %}
                        <a 
                          class="button-danger" 
                          href="{{ participation.get_payment_link }}"
                        >
                          Betal
                        </a>
                      {% endif %}
                    </td>
                    <td>Coding Pirates {{ participation.activity.department.name }}</td>
                    <td>{{ participation.activity.start_date }}
                      {% if participation.activity.start_date != participation.activity.end_date %}
                      - {{ participation.activity.end_date }}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="info-box">
            Der er endnu ingen tilmeldt aktiviteter.
          </div>
        {% endif %}
      {% endif %}
    </section>
  </div>
{% endblock %}
