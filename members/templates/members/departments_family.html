{% extends 'members/base.html' %}

{% block heading %}
{% load staticfiles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
<script src="{% static "members/js/jmespath.js" %}" type="text/javascript"></script>
<script type="text/javascript">
    var departments = {{ departments_json | safe }}
    var markers = [];
    var infoElement;
    var activeMarkerIndex = 0;
    var activeIcon = L.icon({
        iconUrl: '{% static "members/icons/activeIcon.png" %}',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.2.0/dist/images/marker-shadow.png',
        shadowSize: [41, 41],
    });
    var defaultIcon = L.icon({
        iconUrl: "{% static "members/icons/marker-icon.png" %}",
        shadowUrl: "{% static "members/icons/marker-shadow.png" %}",
        iconSize: [25,41],
        iconAnchor: [12,41],
        popupAnchor: [1,-34],
        tooltipAnchor: [16,-28],
        shadowSize: [41,41]}
    )

    function createHTML(department) {
        return "<h4>Coding Pirates " + department["name"] + "</h4>" + "<table class=\"departmentTable\"><tbody><tr><td>Afdelingsleder: </td><td>" + department["responsible_name"] + "</td></tr><tr><td>Kontakt: </td><td>" + department["responsible_contact"] + "</td></tr><tr><td>Møde tid: </td><td>" + department["open_hours"] + "</td></tr></tbody></table>" + (department["isOpening"] ? "<p><i>Afdelingen åbner snart</i></p>" : "");
    }

    function show(e) {
        var result = jmespath.search(departments, "[?latitude=='" + e["latlng"]["lat"] + "']")[0];
        markers[activeMarkerIndex].setIcon(defaultIcon);
        activeMarkerIndex = departments.indexOf(result);
        console.log(e.target.setIcon(activeIcon));
        infoElement.innerHTML = createHTML(result);
    }

    $(document).ready(function() {
        var southEast = L.latLng(54.91711327768886, 8.76734733581543);
        var northEast = L.latLng(58.038693522227945, 14.979954628418003);
        var kort = L.map('kort').fitBounds([southEast, northEast]);
        L.tileLayer('https://api.mapbox.com/styles/v1/codingpirates/cjdaaa7yt3qts2rrwzpsx5ysw/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY29kaW5ncGlyYXRlcyIsImEiOiJjamRhN3JtZHgxamphMzNvMHpraTJra2J1In0.lVqzzzCf9gHneicqDONuaw', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            accessToken: 'pk.eyJ1IjoiY29kaW5ncGlyYXRlcyIsImEiOiJjamRhOXM1ZGIwdm04MnlvMnQ5dDBsdWpkIn0.NMaydnMG6m8OBpJhUbNgzg'
        }).addTo(kort);

        infoElement = document.getElementById("infoElement")

        for(var i = 0; i < departments.length; i++) {
            var row = departments[i];
            if(!row["onMap"]) { continue };
            markers.push(L.marker([row["latitude"], row["longitude"]]).addTo(kort).on('click', show));
        }
    });
</script>
<style>
:root {
    --secondSize: 400px;
}

#wrapper {
    /* width: 100vw;
    max-width: 100%; */
    overflow: hidden; /* will contain if #first is longer than #second */
}
#wrapper > * {
    height: 60vh;
}
.first {
    width: calc(100vw - var(--secondSize));
    float:left; /* add this */
}
.second {
    overflow: hidden; /* if you don't want #second to wrap below #first */
    padding: 1rem;
}
.departmentTable > tbody > tr > td:first-child{
    font-weight: bold;
    padding-right: 1.4rem;
}
</style>
{% endblock %}

{% block content %}
{% load waiting_list %}
<div class="container">
    <h1>Afdelinger</h1>
</div>
<div id="wrapper">
    <div id="kort" class="first"></div>
    <div class="second" id="infoElement" style="background-color: #2C8098; color: white">Vælg en afdeling på kortet for at se mere</div>
</div>

<div class="container">
    <p></p>
    {% for person in children %}
    <h4>{{person.name}}</h4>
    <table class="table table-striped">
        <thead>
            <tr><th>Afdeling</th><th>Plads</th></tr>
        </thead>
        <tbody>
            {% if person in in_waiting_list %}
            {% for waiting_listsROW in waiting_lists %}
            <tr>
                {% if waiting_listsROW.person == person %}
                    <td>{{ waiting_listsROW.department.name }}</td>
                    <td>{% number_on_waiting_list waiting_listsROW %}. i køen</td>
                {% endif %}
            </tr>
            {% endfor %}
            {% else %}
                <tr><td colspan="2"><i>Endnu ikke på nogen ventelister</i></td></tr>
            {% endif %}
        </tbody>
    </table>
    {% endfor %}
</div>

{% endblock %}