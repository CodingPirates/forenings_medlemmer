{% extends 'members/base.html' %}

{% block heading %}
{% load staticfiles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>

<script type="text/javascript">
    var departments = {{ departments_json | safe }}
    var markers = [];
    var infoElement;
    var activeMarkerIndex = 0;
    var activeIcon = L.icon({
        iconUrl: '{% static "members/icons/activeIcon.png" %}',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.2.0/dist/images/marker-shadow.png',
        shadowSize: [41, 41],
    });
    var defaultIcon = L.icon({
        iconUrl: "{% static "members/icons/marker-icon.png" %}",
        shadowUrl: "{% static "members/icons/marker-shadow.png" %}",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        tooltipAnchor: [16, -28],
        shadowSize: [41, 41]
    });

    function createHTML(department) {
        return "<h4>Coding Pirates " + department["name"] + "</h4>" + "<p><table class=\"departmentTable\"><tbody><tr><td>Afdelingsleder: </td><td>" + department["responsible_name"] + "</td></tr><tr><td>Kontakt: </td><td>" + department["responsible_contact"] + "</td></tr><tr><td>Møde tid: </td><td>" + department["open_hours"] + "</td></tr><tr><td>Adresse: </td><td>" + department["streetname"] + " " + department["housenumber"] + ", " + department["zipcode"] + " " + department["city"] + "</td></tr></tbody></table></p>" + "<p>" + department["description"] + "</p>" + "<a style=\"color: white;\" href=\"" + department["website"] + "\">" + department["website"] + "</a>" + (department["isOpening"] ? "<p><i>Afdelingen åbner snart</i></p>" : "");
    }

    // Når der trykkes på en afdeling, og der skal vises mere
    function show(e) {
        // Find den afdeling der skal vises, udfra latlng
        var result = departments.filter(department => department.latitude == parseFloat(e["latlng"]["lat"]) && department.longitude == parseFloat(e["latlng"]["lng"]))[0]
        markers[activeMarkerIndex].setIcon(defaultIcon);
        activeMarkerIndex = departments.indexOf(result);
        e.target.setIcon(activeIcon);
        infoElement.innerHTML = createHTML(result);
    }

    $(document).ready(function () {
        var southEast = L.latLng(54.91711327768886, 8.76734733581543);
        var northEast = L.latLng(58.038693522227945, 14.979954628418003);
        var kort = L.map('kort').fitBounds([southEast, northEast]);
        L.tileLayer('https://api.mapbox.com/styles/v1/codingpirates/cjdaaa7yt3qts2rrwzpsx5ysw/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY29kaW5ncGlyYXRlcyIsImEiOiJjamRhN3JtZHgxamphMzNvMHpraTJra2J1In0.lVqzzzCf9gHneicqDONuaw', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            accessToken: 'pk.eyJ1IjoiY29kaW5ncGlyYXRlcyIsImEiOiJjamRhOXM1ZGIwdm04MnlvMnQ5dDBsdWpkIn0.NMaydnMG6m8OBpJhUbNgzg'
        }).addTo(kort);

        $('.searchAbleDropdowns').select2();

        infoElement = document.getElementById("infoElement")

        for (var i = 0; i < departments.length; i++) {
            var row = departments[i];
            if (!row["onMap"]) { continue };
            markers.push(L.marker([row["latitude"], row["longitude"]]).addTo(kort).on('click', show));
        }
    });


    var departmentIds = [{% for row in departments %}{ "name": "{{row.name}}", "id": {{ row.id }} }, {% endfor %} { }]

    function waiting_listAdd(personId, departmentId) {
        var url = "/waiting_list/" + personId + "/" + departmentId + "/subscribe"

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                // Typical action to be performed when the document is ready:
                var ref = document.getElementById("person_table_" + personId);
                // Test for om <i>Endnu ikke på nogen ventelister</i> skal fjernes
                if(ref.getElementsByTagName("tbody")[0].getElementsByTagName("tr") > 0 && ref.getElementsByTagName("tbody")[0].getElementsByTagName("tr")[0].getElementsByTagName("td")[0].classList.contains("none_yet") > 1) { //.getAttribute("colspan")
                    ref.getElementsByTagName("tbody")[0].removeChild(ref.getElementsByTagName("tbody")[0].getElementsByTagName("tr")[0]);
                }
                var data = departmentIds.filter(department => department.id == departmentId)
                ref = ref.insertRow();
                ref.insertCell().innerHTML = data[0]["name"];
                ref.insertCell().innerHTML = "<a href=\"javascript:window.location.href=window.location.href\">Reload page</a>";
                ref.insertCell().innerHTML = "<button class=\"btn btn-danger\" onclick=\"waiting_listRemove('" + personId + "', '" + departmentId + "', this)\">Afmeld</button>";
            }
        };
        xhttp.open("GET", url, true);
        xhttp.send();
    }

    function waiting_listRemove(personId, departmentId, caller) {
        var url = "/waiting_list/" + personId + "/" + departmentId + "/unsubscribe"

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                // Typical action to be performed when the document is ready:
                caller.parentNode.parentNode.remove();
            }
        };
        xhttp.open("GET", url, true);
        xhttp.send();
    }
</script>
<style>
    :root {
        --secondSize: 400px;
    }

    #wrapper {
        /* width: 100vw;
    max-width: 100%; */
        overflow: hidden;
        /* will contain if #first is longer than #second */
    }

    #wrapper>* {
        height: 60vh;
    }

    .first {
        width: calc(100vw - var(--secondSize));
        float: left;
        /* add this */
    }

    .second {
        overflow: hidden;
        /* if you don't want #second to wrap below #first */
        padding: 1rem;
    }

    .departmentTable>tbody>tr>td:first-child {
        font-weight: bold;
        padding-right: 1.4rem;
    }
    .departmentTable>tbody>tr>td {
        vertical-align: top;
    }
</style>
{% endblock %}

{% block content %}
{% load waiting_list %}
<div class="container">
    <h1>Afdelinger</h1>
</div>
<div id="wrapper">
    <div id="kort" class="first"></div>
    <div class="second" id="infoElement" style="background-color: #2C8098; color: white">Vælg en afdeling på kortet for
        at se mere</div>
</div>

<div class="container">
    <p></p>
    {% for person in children %}
    <h4>{{person.name}}</h4>
    <table class="table table-striped" id="person_table_{{ person.id }}">
        <thead>
            <tr>
                <th>Afdeling</th>
                <th>Plads</th>
                <th>Handlinger</th>
            </tr>
        </thead>
        <tbody>
            {% if person in in_waiting_list %}
            {% for waiting_listsROW in waiting_lists %}
            <tr>
                {% if waiting_listsROW.person == person %}
                <td>{{ waiting_listsROW.department.name }}</td>
                <td>{% number_on_waiting_list waiting_listsROW %}. i køen</td>
                <td><button class="btn btn-danger"
                        onclick="waiting_listRemove('{{ person.id }}', '{{ waiting_listsROW.department.id }}', this)">Afmeld</button>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td class="none_yet" colspan="3"><i>Endnu ikke på nogen ventelister</i></td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    <i>Opskriv på venteliste</i>
    <p>
        <select class="searchAbleDropdowns">
            {% for row in departments %}
            <option value="{{ row.id }}">Coding Pirates {{ row.name }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-success"
            onclick="waiting_listAdd('{{ person.id }}', this.parentNode.children[0].value )">Opskriv</button>
    </p>
    {% endfor %}
</div>

{% endblock %}