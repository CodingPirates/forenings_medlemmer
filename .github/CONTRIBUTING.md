# Contributing

You are more than welcome to contribute to the system. This guide documents how to create a local development setup, the tools/frameworks used, and the steps required to get a pull request approved.

## Getting a local setup

- Installing Docker: Download and install [Docker Compose][docker-guide]. If
    you use Ubuntu 18.04 (LTS), you can use [this guide][docker-ubuntu-guide] to
    set up Docker.

- Fork this repo to your own account.

- The setup adheres to the [twelve-factor-app][12f] principles. To get a
    local development configuration, copy the file `.env.example` to `.env`

- Run `docker compose up` to start your local system.  
  (If on Apple Silicon machine, run `docker compose -f docker-compose.yml -f docker-compose.arm64.yml up --build`)

- Run `docker compose run web ./manage.py get_live_data` to download public
    data and insert it into your local database.

- To get some dummy members, families, etc. you can use the [factories][factories] to create them.

    ```bash
        docker compose run web ./manage.py shell
        from members.tests.factories import MemberFactory
        MemberFactory.create_batch(20)
    ```

    Creates 20 members with associated families, departments, etc.
    Note that the data generated by the factories is not entirely consistent
    with the real world. For instance each member belongs to their own department.

- To create a super user for the admin interface you can run
    `docker compose run web ./manage.py createsuperuser`

- A pgAdmin container is configured as part of Docker Compose, and can be accessed on <http://localhost:5050>.
    Log in with credentials `admin@example.com`/`admin`. Connection to database has been configured in
    `pgadmin/servers.json` file, you just need to provide password to database when asked (can be found
    in your `.env` file)

- To enable auto formatting with black on Linux: 
    copy the pre-commit file into the .git/hooks directory
    ```bash
    cp pre-commit .git/hooks
    ```
    and then give it executeable permissions
    ```bash
    chmod +x .git/hooks/pre-commit
    ```
    Note: This only works on Unix. (MacOS or Linux) And only if you have black installed on python3 with
    ```bash
    python3 -m pip install black
    ```

> **_NOTE:_** If using linux with SELINUX you may need to add/change the following to your docker-compose.yml
>
> ``` yml
>services:
>   web:
>       privileged: true <-- add this
>       ...
> ```

## Primary Frameworks/Systems used

- [Django][django]: The base web framework used. The link is to their great
    tutorial which takes an hour or two to complete.
- [Docker][docker-tutorial]: We use `docker compose` to setup database,
    environment and dependencies. The following commands is all that's required
    to work on the system.

  - `docker compose build` -- Builds the system.
  - `docker compose up` -- Starts the systems.
  - `docker compose down && docker volume rm backend_database`
        \-- Deletes your local database
  - `docker compose run web command` -- Replace `command` with what you want
        to run in the system.

- [SASS][sass]: CSS files belong in `members/static/members/sass`,
    store it as either plain `.css` files or `.scss` files.
    Compilation happens during each build, during local development run the
    following command in a separate terminal:

    ```bash
    docker compose run web node_modules/.bin/sass --watch members/static/members/sass/main.scss members/static/members/css/main.css
    ```

    It will compile SASS when you save a file.
    If you create a new `.scss` file remember to add it to [main.scss][main.scss].

- [HTML documentation][html_docs] Shows the css classes that can used for
    formatting.

- [Selenium][selenium]: runs the functional tests. To run a specific test run

    ```bash
        docker compose run web ./manage.py test members.tests.test_functional.test_create_family
    ```

    where the name of your tests replaces the last part.

- [Unit tests][unittest]: runs the unittests. You run the unit tests the same way as the selenium tests. To run a specific test run

    ```bash
        docker compose run web ./manage.py test members.tests.test_dump_data
    ```

    where the name of your tests replaces the last part.


- [Quickpay][quickpay]: We use QuickPay for payments, `.env.example`
    contains a test api key. Quickpay has a series of cards that can be used
    [for testing][quickpay_cards]

### Local development

Pragmatic development is to use docker for database and run server and/or tests locally

- Install Poetry
- Install python dependencies: `poetry install`
- Install npm
- Install npm dependencies: `npm install`
- Copy the sample environment file: `cp .env.example .env`

- boot the database with `docker compose start database`
- boot a selenium docker with `docker run -it -p 4444:4444 -p 7900:7900 --network="host" -v /dev/shm:/dev/shm selenium/standalone-chrome`
- start the virtual env shell and work from there further on with `poetry shell`
- Run sass: `./node_modules/.bin/sass members/static/members/sass/main.scss`
- Run collectstatic: `./manage.py collectstatic --no-input --clear`
- Run the tests: `./manage.py test`

From here on you can boot a development server and optionally populate it with some arbitrary data:

- Boot development server : ``

You can load some sample data into the local development environment by starting the django console with `./manage.py shell` and then

```python
from members.tests.factories.member_factory import MemberFactory
MemberFactory.create_batch(20)
```

In the same console you can create a password for the first person, so you can login:

```python
from members.models import Person
p = Person.objects.first()
p.user.set_password('test')
p.user.save() # store in DB
p.user.username # show login email
```

## Creating a pull request

1. Join our [slack][slackinvite] and introduce yourself in the _medlemssystem_dev_ channel.
2. Pick a card from either the `backlog` or `to-do` column on the
    [project page][project-link].
3. Open a draft pull request before writing any code. This ensures that the design
    discussion happens before the code and limits duplicate work.
4. Help us specify the requirements specification.
5. Code the features with tests, see the [testing guide][test_guide]
6. Run the entire test suite with: `docker compose run web ./manage.py test`
7. Check that the following requirements are meet:
    - The code has tests, code without tests is not accepted. (Except for
        minimal CSS and text changes). Use the existing test as inspiration and
        the [factories][factories] to create dummy data.
    - The code conforms to the [black][black] formatting rules. To format your
        code run `docker compose run web black .`. Consider looking for an
        editor integration.
    - The code passes [flake8][flake8] checks.
8. Submit the pull request.
9. The backend is [Heroku][heroku], we can use their "review apps" to create
    a temporary server for each pull request.

## Deploying

See [DEPLOYING.md](DEPLOYING.md) for instructions on deploying to test, staging and production environments.

[test_guide]: https://github.com/CodingPirates/forenings_medlemmer/wiki/Writing-tests

[heroku]: https://heroku.com

[docker-guide]: https://docs.docker.com/compose/install/

[docker-tutorial]: https://docker-curriculum.com

[docker-ubuntu-guide]: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04

[flake8]: https://flake8.pycqa.org/en/latest/

[project-link]: https://github.com/CodingPirates/forenings_medlemmer/projects/2

[sass]: https://sass-lang.com

[factories]: ./members/tests/factories

[slackinvite]: https://slackinvite.codingpirates.dk

[12f]: https://12factor.net

[django]: https://docs.djangoproject.com/en/3.0/intro/tutorial01/

[black]: https://black.readthedocs.io/en/stable/

[selenium]: https://www.selenium.dev

[unittest]: https://docs.djangoproject.com/en/4.1/topics/testing/

[main.scss]: https://github.com/CodingPirates/forenings_medlemmer/blob/master/members/static/members/sass/main.scss

[html_docs]: https://github.com/CodingPirates/forenings_medlemmer/wiki/HTML-formatting

[quickpay]: https://learn.quickpay.net/tech-talk/api/

[quickpay_cards]: https://learn.quickpay.net/tech-talk/appendixes/test/
